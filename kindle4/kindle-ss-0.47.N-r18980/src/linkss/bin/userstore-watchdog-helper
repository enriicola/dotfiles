#!/bin/sh
#
# $Id: userstore-watchdog-helper 15011 2018-06-02 16:58:21Z NiLuJe $
#

# Get hackname from the script's path (NOTE: Will only work for scripts called from /mnt/us/${KH_HACKNAME}/bin)
KH_HACKNAME="${0##/mnt/us/}"
KH_HACKNAME="${KH_HACKNAME%%/bin/*}"

# Try to pull our custom helper lib
_KH_FUNCS="/mnt/us/${KH_HACKNAME}/bin/libkh"
if [ -f ${_KH_FUNCS} ] ; then
    . ${_KH_FUNCS}
else
    # Pull default helper functions for logging
    _FUNCTIONS=/etc/rc.d/functions
    [ -f ${_FUNCTIONS} ] && . ${_FUNCTIONS}
    # We couldn't get our custom lib, abort
    msg "couldn't source libkh from '${KH_HACKNAME}'" W
    exit 0
fi

# Make sure shlock is exec'able
[ -x ${USWD_LOCK_BIN} ] || chmod +x ${USWD_LOCK_BIN}
# Make sure our lockfile has somewhere to live
[ -d ${USWD_LOCK_DIR} ] || mkdir -p ${USWD_LOCK_DIR}

# Add the PID of the lipc-wait-event(s) to the list of running daemons to kill
echo "$( pidof lipc-wait-event )" >> ${US_WATCHDOG_PID}
# Add our PID to the list of running daemons to kill
echo "$$" >> ${US_WATCHDOG_PID}

while read line ; do
    # Did we really come back from an USBMS session?
    if echo "${line}" | grep -q "userstoreAvailable" ; then
        # Yep, we did! Let's do our stuff in a locked session...
        if ${USWD_LOCK_BIN} -p $$ -f ${USWD_LOCK_FILE} ; then
            # Log it
            kh_msg "came back from usbms, respawn inotify watches" I q
            # Only kill inotifywait & the helper, let the watchdog take care of respawn
            if [ -f ${COVER_WATCHDOG_PID} ] ; then
                for pid in $( cat ${COVER_WATCHDOG_PID} ) ; do
                    # Check that's it's really one of our own process before killing it mercilessly :p
                    if ps -fp ${pid} | grep -q -e "${COVERWD_INWAIT_BIN}" -e "${COVER_WATCHDOG_HELPER}" ; then
                        kh_msg "killing cover watchdog process (${pid})" I q
                        kill -TERM ${pid} 2> /dev/null
                    fi
                done
            fi
            # And then remove our lock file
            rm -rf ${USWD_LOCK_FILE}
        else
            # Unreachable?
            kh_msg "we're already respawning inotifywait via watchdog, go away" W a "inotify reset already in progress"
        fi
    fi
done
